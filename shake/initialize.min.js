var width=0<window.innerWidth?window.innerWidth:screen.width,height=0<window.innerHeight?window.innerHeight:screen.height,width=Math.min(640,width),height=Math.min(500,height),height=Math.max(480,height);console.log("width & height:  "+width+", "+height);var overlay,layer,map,lon=-120,lat=40,margin=30,plotContainerHeight=200,plotWidth=width-2*margin,plotHeight=plotContainerHeight-2*margin,paddingFraction=0.15,paddedExtent;
d3.select("body").append("div").attr("id","map").style("width",width+"px").style("height",height-plotContainerHeight+"px");
var svg=d3.select("body").append("svg").style("width",width).style("height",plotContainerHeight),subPlot=svg.append("g").attr("transform","translate("+margin+", "+margin/2+")"),x=d3.time.scale().range([0,plotWidth]),y=d3.scale.linear().range([plotHeight,0]),xAxis=d3.svg.axis().scale(x).orient("bottom").ticks(4),yAxis=d3.svg.axis().scale(y).orient("left").ticks(4),line=d3.svg.line().x(function(b){return x(b.time)}).y(function(b){return y(b.mag)}),brush=d3.svg.brush().x(x).y(y).on("brush",brushed);
map=new google.maps.Map(document.getElementById("map"),{zoom:1,center:new google.maps.LatLng(lat,lon),mapTypeId:google.maps.MapTypeId.TERRAIN});overlay=new google.maps.OverlayView;var script=document.createElement("script");script.src="http://earthquake.usgs.gov/earthquakes/feed/geojsonp/2.5/week";document.getElementsByTagName("head")[0].appendChild(script);var data=[];
function eqfeed_callback(b){for(var d,f,h=0;h<b.features.length;h++)d=b.features[h],f=d.geometry.coordinates,d={mag:d.properties.mag,time:d.properties.time,lon:f[0],lat:f[1],depth:f[2]},data.push(d);console.log("data.length: "+data.length);paddedExtent=d3.extent(data.map(function(a){return a.mag}));paddedExtent[1]=+paddedExtent[1]+paddingFraction*(paddedExtent[1]-paddedExtent[0]);x.domain(d3.extent(data.map(function(a){return a.time})));y.domain(paddedExtent);subPlot.append("rect").attr("width",plotWidth).attr("height",
plotHeight).attr("stroke-width",1).attr("stroke","black").attr("fill","none");subPlot.append("g").attr("transform","translate(0,"+plotHeight+")").call(xAxis);subPlot.append("g").attr("transform","translate(0,0)").call(yAxis);subPlot.selectAll(".dot").data(data).enter().append("circle").attr("class","dot").attr("cx",function(a){return x(a.time)}).attr("cy",function(a){return y(a.mag)}).attr("r",5);subPlot.append("g").attr("class","x brush").call(brush);overlay.onAdd=function(){var a=d3.select(this.getPanes().overlayLayer).append("div").attr("class",
"stations");overlay.draw=function(){function b(a){this.time=a.time;this.mag=a.mag;var e=a.time;a=new google.maps.LatLng(a.lat,a.lon);a=d.fromLatLngToDivPixel(a);return d3.select(this).style("left",a.x-g+"px").style("top",a.y-g+"px").attr("id",e)}var d=this.getProjection(),g=10;a.selectAll("svg").data(data).each(b).enter().append("svg:svg").each(b).attr("class","marker").append("svg:circle").attr("r",4.5).attr("cx",g).attr("cy",g)}};overlay.toggle=function(a){var b,d,g,f;2==a[1].length?(b=a[0][0],
g=a[0][1],d=a[1][0],f=a[1][1]):(b=a[0],d=a[1]);layer=this.getPanes().overlayLayer;var e=layer.getElementsByTagName("svg"),h=e.length;if(2==a[1].length)for(var c=0;c<h;c++)e[c].style.visibility=e[c].time<b||e[c].time>d||e[c].mag<g||e[c].mag>f?"hidden":"visible";else for(c=0;c<h;c++)e[c].style.visibility=e[c].time<a[0]||e[c].time>a[1]?"hidden":"visible"};overlay.setMap(map)}function brushed(){overlay.toggle(brush.empty()?x.domain():brush.extent())};
