var width=window.innerWidth>0?window.innerWidth:screen.width;var height=window.innerHeight>0?window.innerHeight:screen.height;width=Math.min(960,width);height=Math.min(500,height);height=Math.max(480,height);console.log("width & height:  "+width+", "+height);var overlay,layer,map,lon=-120,lat=30,margin=30,plotContainerHeight=200,plotWidth=width-2*margin,plotHeight=plotContainerHeight-2*margin,paddingFraction=.15,paddedExtent;d3.select("body").append("div").attr("id","map").style("width",width+"px").style("height",height-plotContainerHeight+"px");var svg=d3.select("body").append("svg").style("width",width).style("height",plotContainerHeight);var subPlot=svg.append("g").attr("transform","translate("+margin+", "+margin/2+")");var x=d3.time.scale().range([0,plotWidth]),y=d3.scale.linear().range([plotHeight,0]);var xAxis=d3.svg.axis().scale(x).orient("bottom").ticks(4),yAxis=d3.svg.axis().scale(y).orient("left").ticks(4);var line=d3.svg.line().x(function(d){return x(d.time)}).y(function(d){return y(d.mag)});var brush=d3.svg.brush().x(x).y(y).on("brush",brushed);map=new google.maps.Map(document.getElementById("map"),{zoom:1,minZoom:1,center:new google.maps.LatLng(lat,lon),mapTypeId:google.maps.MapTypeId.TERRAIN});overlay=new google.maps.OverlayView;var script=document.createElement("script");script.src="http://earthquake.usgs.gov/earthquakes/feed/geojsonp/2.5/week";document.getElementsByTagName("head")[0].appendChild(script);var data=[];function eqfeed_callback(results){var earthquake,coords,quake;for(var i=0;i<results.features.length;i++){earthquake=results.features[i];coords=earthquake.geometry.coordinates;quake={mag:earthquake.properties.mag,time:earthquake.properties.time,lon:coords[0],lat:coords[1],depth:coords[2]};data.push(quake)}console.log("data.length: "+data.length);paddedExtent=d3.extent(data.map(function(d){return d.mag}));paddedExtent[1]=+paddedExtent[1]+paddingFraction*(paddedExtent[1]-paddedExtent[0]);x.domain(d3.extent(data.map(function(d){return d.time})));y.domain(paddedExtent);subPlot.append("rect").attr("width",plotWidth).attr("height",plotHeight).attr("stroke-width",1).attr("stroke","black").attr("fill","none");subPlot.append("g").attr("transform","translate(0,"+plotHeight+")").call(xAxis);subPlot.append("g").attr("transform","translate(0,0)").call(yAxis);subPlot.selectAll(".dot").data(data).enter().append("circle").attr("class","dot").attr("cx",function(d){return x(d.time)}).attr("cy",function(d){return y(d.mag)}).attr("r",5);subPlot.append("g").attr("class","x brush").call(brush);overlay.onAdd=function(){var layer=d3.select(this.getPanes().overlayLayer).append("div").attr("class","stations");overlay.draw=function(){var projection=this.getProjection(),padding=10;var marker=layer.selectAll("svg").data(data).each(transform).enter().append("svg:svg").each(transform).attr("class","marker");marker.append("svg:circle").attr("r",4.5).attr("cx",padding).attr("cy",padding);function transform(d){this.time=d.time;this.mag=d.mag;var t=d.time;d=new google.maps.LatLng(d.lat,d.lon);d=projection.fromLatLngToDivPixel(d);return d3.select(this).style("left",d.x-padding+"px").style("top",d.y-padding+"px").attr("id",t)}}};overlay.toggle=function(extent){var xMin,xMax,yMin,yMax;if(extent[1].length==2){xMin=extent[0][0];yMin=extent[0][1];xMax=extent[1][0];yMax=extent[1][1]}else{xMin=extent[0];xMax=extent[1]}layer=this.getPanes().overlayLayer;var dots=layer.getElementsByTagName("svg");var nDots=dots.length;if(extent[1].length==2){for(var i=0;i<nDots;i++){if(dots[i].time<xMin||dots[i].time>xMax||dots[i].mag<yMin||dots[i].mag>yMax){dots[i].style.visibility="hidden"}else{dots[i].style.visibility="visible"}}}else{for(var i=0;i<nDots;i++){if(dots[i].time<extent[0]||dots[i].time>extent[1]){dots[i].style.visibility="hidden"}else{dots[i].style.visibility="visible"}}}};overlay.setMap(map)}function brushed(){overlay.toggle(brush.empty()?x.domain():brush.extent())}
