function scatter(t){function e(){function t(t){return t.time>e[0]&&t.time<e[1]?1:0}var e=f.extent();e[1].toDateString()==e[0].toDateString()&&e[1].setFullYear(e[0].getFullYear()+1),f.extent(e),d3.select(".x.brush").call(f),myDots=d3.selectAll("circle.quake").style("fill-opacity",t)}var a={top:80,right:20,bottom:30,left:80},r=5e3,n=650-a.left-a.right,l=300-a.top-a.bottom,s=d3.select("#scatter").append("svg").attr("width",n+a.left+a.right).attr("height",l+a.top+a.bottom).append("g").attr("id","scatter_svg"),i=d3.time.scale().domain(d3.extent(t.map(function(t){return t.time}))).range([0,r]),o=i.range([0,n]),c=d3.scale.linear().domain(d3.extent(t.map(function(t){return t.mag}))).range([l,0]),u=d3.svg.axis().scale(o).ticks(d3.time.years).tickSize(6,0).orient("bottom"),d=d3.svg.axis().scale(c).ticks(4).tickSize(6,0).orient("left"),f=d3.svg.brush().x(o).on("brush",e),p=s.append("g").attr("transform","translate("+a.left+","+a.top+")");p.append("g").attr("class","y axis").call(d),p.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(u).selectAll(".tick text").style("text-anchor","start").attr("x",6).attr("y",8),p.append("text").attr("class","x label").attr("text-anchor","middle").attr("x",n/2).attr("y",0).attr("dy","-.75em").text("Earthquakes"),p.append("text").attr("class","y label").attr("text-anchor","middle").attr("x",-l/2).attr("y",-6-a.left/3).attr("dy","-.75em").attr("transform","rotate(-90)").text("Magnitudes"),p.selectAll("circle.scatter").data(t).enter().append("circle").attr("class","scatter").style("fill","red").attr("cx",function(t){return o(t.time)}).attr("cy",function(t){return c(t.mag)}).attr("r",1),p.append("g").attr("class","x brush").call(f).selectAll("rect").attr("y",-6).attr("height",l+7)}function startBrushTransition(t,e,a){var r=e.domain(),n=new Date(r[0]),l=new Date(r[0]).setFullYear(n.getFullYear()+1),s=new Date(r[1]),i=new Date(r[1]).setFullYear(s.getFullYear()-1),o=(l-n)/(s-n);d3.select(".x.brush").call(t.extent([n,n])).transition().ease("linear").duration(o*a).call(t.extent([n,l])).transition().ease("linear").duration((1-o)*a).call(t.extent([i,s]))}function addButton(t,e,a,r){{var n=.5,l=220*n,s=80*n,i=10*n,o=10*n,c=120*n,u=66*n,d=d3.select("#scatter_svg").append("g").attr("transform","translate( 10,10)");d.append("rect").attr("id","restartButton").attr("width",l+"px").attr("height",s+"px").style("fill","steelblue").attr("x",i).attr("y",o).attr("ry",s/10)}d.append("text").attr("id","buttonText").attr("x",c).attr("y",u).style("text-align","center").style("text-anchor","middle").style("fill","#fff").style("stroke","none").style("font-family","sans-serif").style("font-size",s/2+"px").text("Start"),d.append("rect").attr("width",l+"px").attr("height",s+"px").style("opacity",0).style("pointer-events","all").attr("x",i).attr("y",o).attr("ry",s/2).on("click",function(){return restart(t,e,a,r)})}function clearButton(){d3.select("#buttonText").text(""),d3.select("#restartButton").style("fill","#ffffff")}function resetButton(){d3.select("#restartButton").transition().ease("linear").duration(1e3).style("fill","#428bca"),d3.select("#buttonText").text("Restart").transition().ease("linear").duration(1e3).style("fill","#fff")}function restart(t,e,a,r){{var n=e.domain();n[1].setUTCFullYear(n[1].getFullYear()-1),t/Math.max(n[1].getFullYear()-n[0].getFullYear(),1)}d3.selectAll("circle.quake").style("fill-opacity",0).transition().delay(function(t){return e(a(t))}).style("fill-opacity",1),d3.selectAll("circle.quake").style("fill-opacity",0).transition().delay(function(t){return e(a(t))}).style("fill-opacity",1),clearButton();d3.timer(function(){return resetButton(),!0},t),startBrushTransition(r,e,t)}!function(){function t(t,i,o){function c(t){var e=t.coordinates;return 0<e[0]&&e[0]<a&&0<e[1]&&e[1]<r}if(t)return console.error(t);var u=o.objects.ne_50m_admin_1_states_provinces_lakes.geometries.map(function(t){return topojson.feature(o,t)});u=u.filter(function(t){return"United States of America"==t.properties.admin}),u=u.filter(function(t){return"Alaska"!=t.properties.name&&"Hawaii"!=t.properties.name}),u={type:"FeatureCollection",features:u};var d=s.bounds(u),f=d[1][0]-d[0][0],p=d[1][1]-d[0][1],y=(d[0][0]+d[1][0])/2,m=(d[0][1]+d[1][1])/2,g=.9/Math.max(f/a,p/r),x=[a/2-g*y,r/2-g*m],h=Object.keys(i.objects).map(function(t){return topojson.feature(i,i.objects[t])});i=[],h.forEach(function(t){i=i.concat(t.features)}),console.log("# of quakes BEFORE: "+i.length),i=i.map(function(t){var e=t.geometry.coordinates,a=t.properties;return{coordinates:l([e[0],e[1]]),mag:+a.mag,time:new Date(a.time)}}),i=i.filter(c),console.log("# of quakes AFTER: "+i.length),scatter(i),n.datum(u).append("path").style("fill","gray").style("stroke","black").style("stroke-width","1px").attr("d",s),n.selectAll("circle.quake").data(i).enter().append("circle").attr("class","quake").style("fill","orange").attr("cx",function(t){return t.coordinates[0]}).attr("cy",function(t){return t.coordinates[1]}).attr("r",1),n.transition().duration(2e3).style("stroke-width",1.5/g+"px").attr("transform","translate("+x+")scale("+g+")");var b=3;n.append("rect").attr("x",e.left-b/2).attr("y",e.top+b/2).attr("width",a).attr("height",r).style("fill","none").style("stroke","#000000").style("stroke-width",b+"px")}var e={top:50,right:50,bottom:50,left:50},a=960-e.left-e.right,r=500-e.top-e.bottom,n=d3.select("#map").append("svg").attr("width",a+e.left+e.right).attr("height",r+e.top+e.bottom).append("g").attr("transform","translate("+e.left+", "+e.top+")"),l=d3.geo.albers();l.scale(800);var s=d3.geo.path().projection(l);queue().defer(d3.json,"quakes.json").defer(d3.json,"naturalearth.json").await(t)}();