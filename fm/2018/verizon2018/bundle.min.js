var width=960,height=500;var radius=3;var fmblue=["#007697","#1A84A2","#3391AC","#4D9FB6","#66ADC1","#7FBACB","#99C8D5","#B2D6E0","#CCE4EA","#E5F1F4","#FFFFFF"].reverse();var fmnavy=["#000F2B","#1A2741","#333F55","#4D576B","#666F80","#7F8795","#999FAA","#B2B7BF","#CCCFD5","#E5E7E9","#FFFFFF"].reverse();d3.interpolateFMblue=d3.scaleQuantize().range(fmblue);d3.interpolateFMnavy=d3.scaleQuantize().range(fmnavy);var color=d3.interplateFMblue;var circle=d3.symbol().size(25);var x=d3.scaleLog().range([.3,1]);var projection=d3.geoAlbersUsa().scale(1e3);var path=d3.geoPath().projection(projection);var svg=d3.select("body").append("svg").attr("viewBox","0, 0, "+width+", "+height).attr("preserveAspectRatio","xMinYMid").style("width","100%").style("height","100%");svg.append("g").append("rect").attr("width",width).attr("height",height).style("fill","#fff");var hexbin=d3.hexbin().extent([[0,0],[width,height]]).radius(.8*radius);d3.queue().defer(d3.json,"bins2018.json").defer(d3.json,"../data/us.json").await(ready);function ready(error,bins,us){if(error)throw error;x.domain(d3.extent(bins,function(d){return d.count}));mesh=topojson.mesh(us,us.objects.us);usa=topojson.merge(us,us.objects.us.geometries);console.log("before",bins.length);var contains=bins.map(function(d){return false});usa.coordinates.forEach(function(d,i){polygon=d[0].map(function(d){return projection(d)});if(!polygon[0])return;bins.forEach(function(bin,i){contains[i]=contains[i]||d3.polygonContains(polygon,[bin.x,bin.y])})});bins=bins.filter(function(bin,i){return contains[i]});console.log("after",bins.length);svg.append("g").selectAll("path.state").data([usa]).enter().append("path").attr("class","state").style("fill","none").attr("d",path);svg.append("g").selectAll("path.mesh").data([mesh]).enter().append("path").attr("class","mesh").style("fill","none").attr("d",path);var hexagons=svg.append("g").attr("class","hexagons").selectAll("path").data(bins).enter().append("path").attr("d",circle).style("fill","none").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).on("mouseover",function(d){console.log(d3.format(",d")(d.count))});d3.select("input#background").on("change",function(){svg.select("rect").style("fill",this.checked?"#aaa":"#fff")});d3.select("input#land").on("change",recolor);d3.select("input#flat").on("change",recolor);d3.selectAll("form input").on("change",recolor).call(recolor)}function recolor(){var strokeShade=+d3.selectAll("form#strokeshade input:checked").node().value;var strokeWidth=d3.selectAll("form#strokewidth input:checked").node().value;var flat=d3.select("input#flat").node().checked;var land=d3.select("input#land").node().checked;var background=d3.select("input#background").node().checked;var color=null;d3.selectAll("form input").each(function(){if(this.checked)color=d3[this.value]});d3.selectAll(".hexagons path").style("fill",function(d){return flat?color(.7):color(x(d.count))});d3.selectAll("path.state").style("fill",function(d){return land?color(.1):"#ffffff"});d3.selectAll("path.mesh").style("stroke-width",strokeWidth).style("stroke",color(strokeShade));if(typeof svg2png==="function")svg2png()}function svg2png(){var svgString=(new XMLSerializer).serializeToString(d3.select("svg").node());var svgBlob=new Blob([svgString],{type:"image/svg+xml;charset=utf-8"});var svgURL=URL.createObjectURL(svgBlob);var img=new Image;img.onload=image2canvas;img.src=svgURL;function image2canvas(){var canvas=d3.select("body").append("canvas").attr("width",2*width).attr("height",2*height).remove().node();var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);var png=canvas.toDataURL("image/png");URL.revokeObjectURL(png);ctx.canvas.toBlob(function(blob){d3.select("#download-link").attr("href",URL.createObjectURL(blob))})}}