<!DOCTYPE html>
<meta charset="utf-8">
<title>students 4</title>
<link href="styles.css" rel="stylesheet">
<body>
<script src="d3.min.js"></script>
<script>

var width = 960,
    height = 700;

var title = ["Student loans significantly delay homeownership",
    "Student loans do not affect long-term aspirations"]

var text1 = ["54% of renters aged 25-44 will buy on next move.",
    "80% of renters will buy eventually, if not on next move."];

var data = [{key: 'debt',    value: -28 },
            {key: ' ',    value: null},
            {key: '30-34',     value: -9  },
            {key: '35-39',     value: -5  },
            {key: '40-44',     value: -2  },
            {key: '  ',    value: null},
            {key: '$25-49K',  value: 60  },
            {key: '$50-74K',  value: 89  },
            {key: '> $75K',   value: 61  },
            {key: '   ',    value: null},
            {key: 'married', value: 27  }];

var data2 = [{key: 'debt',   value: -7 },
             {key: ' ',    value: null},
             {key: '30-34',     value: -23 },
             {key: '35-39',     value: -6  },
             {key: '40-44',     value: -31 },
             {key: '  ',    value: null},
             {key: '$25-49K',  value: 10  },
             {key: '$50-74K',  value: 13  },
             {key: '> $75K',   value: 34  },
             {key: '   ',    value: null},
             {key: 'married', value: 3  }];

data = [data, data2];

// tooltip content
var tip = { 'debt': 'Renters with student-loan debt are XX% LESS likely to buy than renters without debt',
             ' ':    null,
             '30-34': '30-34 year old renters are XX% LESS likely to buy than 25-29 year olds',
             '35-39': '35-39 year old renters are XX% LESS likely to buy than 25-29 year olds',
             '40-44': '40-44 year old renters are XX% LESS likely to buy than 25-29 year olds',
             '  ':   null,
             '$25-49K': 'Renters making $25-49K are XX% MORE likely to buy than those making less than $25K',
             '$50-74K': 'Renters making $50-74K are XX% MORE likely to buy than those making less than $25K',
             '> $75K': 'Renters making more than $75K are XX% MORE likely to buy than those making less than $25K',
             '   ':  null,
             'married': 'Married renters are XX% more likely to buy than single renters' };

var container = d3.select("body").append("div")
    .attr('id', 'container')

var svg = container.append("svg")
    .attr('viewBox', "0, 0, " + width + ", " + height)
    .attr('preserveAspectRatio', "xMinYMid");

var g = svg.append("g");

g.append("rect")
    .attr("id", "background-rect")
    .attr("width", width)
    .attr("height", height);

// text #1
g.append("text")
    .classed("text1", true)
    .attr("x", width / 2)
    .attr("y", height / 5)
    .attr("dy", '2.5em')
    .style('text-anchor', 'middle')
    .style('font-size', '1.4em')

// Create bar chart
var chart = d3.barChart()
  .x(function(d) { return d.key; })
  .y(function(d) { return +d.value; })
  .width(width)
  .height(height)
  .yDomain([-50, 110])

// Plot data[0]
g.datum(data[0])
    .call(chart);

tooltip = d3.select('body').append('div')
      .classed('tooltip', true)

d3.selectAll(".bar rect")
    .on('mouseover', moused)
    .on('mousemove', moused)
    .on('mouseout', clear)

function clear() {
  tooltip
      .style('left', '-100px')
      .style('top', '-100px')
      .style('border-color', 'transparent')
      .html(null)

  d3.select(this).classed("active", false);
}

function moused(d, i) {
  var h = tooltip.node().clientHeight,
      w = tooltip.node().clientWidth,
      m = d3.mouse( container.node() ),  // position relative to parent div
      maxWidth = container.node().clientWidth;

  var l = Math.min( Math.max(10, m[0] - w / 2), maxWidth - w );
  var t = m[1] - h - 10;

  tooltip
      .style('position', 'absolute')
      .style('pointer-events', 'none')
      .style('left', function() { return l + "px"; })
      .style('top',  function() { return t + "px"; })
      .style('border-style', 'solid')
      .style('border-color', 'black')
      .style('padding', '5px')
      .style('width', '200px')
      .html(function() { return tip[d[0]].replace('XX', Math.abs(d[1])); })

  d3.select(this).classed("active", true);
}

// Title for graphic
g.append('text')
    .attr('id', 'title')
    .attr("x", width / 2)
    .attr("y", '1.7em')
    .style("text-anchor", 'middle')
    .style("font-size", '2.5em')

// Buttons to toggle between the two calculations
g.selectAll(".button")
    .data(['Buy on next move', 'Buy eventually'])
  .enter().append("g")
    .attr("class", "button")
    .attr("transform", function(d, i) { return "translate(" + [(i === 0) ? width / 3 : 2 * width / 3, height / 5] + ")"; })
  .append("text")
    .text(function(d) { return d; })
    .style("text-anchor", 'middle')
    .style("font-size", '2em')
    .each(addButton)

// Initial animation-- click the first button, then wait a bit and click the 2nd
//toggle.call(d3.select(".toggle rect").node(), null, 0);
 setTimeout(function() {
   toggle.call(d3.selectAll(".toggle rect").nodes()[0], null, 0);
 }, 1000)

function addButton(d, i) {
    d3.button()
        .container( d3.select(this.parentNode) )
        .text( d3.select(this) )
        .count( i )
        .cb(function() { return toggle.call(this, d, i); })
        ();
}

function toggle(d, i) {
  // title for graphic
  d3.select("#title")
    .transition()
    .style("fill-opacity", 0)
    .transition()
    .style("fill-opacity", null)
    .text(title[i]);
  // text below each button
  d3.selectAll(".text1")
    .transition()
    .style("fill-opacity", 0)
    .transition()
    .style("fill-opacity", null)
//    .attr('x', function() { return i == 0 ? width / 3 : 2 * width / 3; })
    .text(text1[i]);

  // label in graph
  d3.select("#graph-label")
    .transition()
    .style("fill-opacity", 0)
    .transition()
    .style("fill-opacity", null)
    .style("font-weight", 900)
    .style("stroke", null)
    .text(function() { return i == 0 ? "Buy on next move" : " Buy eventually" })

  xAxis = chart.xAxis();
  yScale = chart.yScale();

  // new data
  d3.selectAll(".bar rect")
      .data( data[i].map(function(d) { return [d.key, +d.value] }) )
    .transition()
      .duration(750)
      .attr("y", function(d) { return ( yScale(0) - yScale(d[1]) ) > 0 ? yScale(d[1]) : yScale(0); })
      .attr("height", function(d) { return Math.abs( yScale(0) - yScale(d[1]) ) });

  // bar labels
  d3.selectAll(".bar text")
      .style('fill', 'none')
      .data( data[i].map(function(d) { return [d.key, +d.value] }) )
    .transition()
      .duration(750)
      .attr("y", function(d) { return ( yScale(0) - yScale(d[1]) ) > 0 ? yScale(d[1]) : yScale(d[1]); })
      .attr("dy", function(d) { return d[1] < 0 ? '-.29em' : '1em'; })
//      .style('fill', function(d) { return (d[1] > 27 || d[1] < -22) ? '#fff' : 'none' })  // statistical significance
      .style('fill', function(d) { return (Math.abs(d[1]) > 5) ? '#fff' : 'none' })  // large
      .text(function(d) { return d[1] + "%"; })
}

setContainerHeight(); // initial load
d3.select(window).on('resize', setContainerHeight);

function setContainerHeight() {
  var w = Math.min(582, parseInt( container.style("width"), 10));
  var a = width / height;
  container.style('width', w + 'px');
  container.style('height', w / a  + 'px');
}

</script>
