var width=960,height=500;var radius=3,bins,hexagons,simulation;var fmblue=["#007697","#1A84A2","#3391AC","#4D9FB6","#66ADC1","#7FBACB","#99C8D5","#B2D6E0","#CCE4EA","#E5F1F4","#FFFFFF"].reverse();var fmnavy=["#000F2B","#1A2741","#333F55","#4D576B","#666F80","#7F8795","#999FAA","#B2B7BF","#CCCFD5","#E5E7E9","#FFFFFF"].reverse();d3.interpolateFMblue=d3.scaleQuantize().range(fmblue);d3.interpolateFMnavy=d3.scaleQuantize().range(fmnavy);var color=d3.interplateFMblue;var circle=d3.symbol().size(25);var x=d3.scaleLog().range([.3,1]);var projection=d3.geoAlbersUsa().scale(1e3);var path=d3.geoPath().projection(projection);var svg=d3.select("body").append("svg").attr("viewBox","0, 0, "+width+", "+height).attr("preserveAspectRatio","xMinYMid").style("width","100%").style("height","100%");svg.append("g").append("rect").attr("width",width).attr("height",height).style("fill","#fff");var hexbin=d3.hexbin().extent([[0,0],[width,height]]).radius(.8*radius);d3.queue().defer(d3.json,"../verizon/bins2016.json").defer(d3.json,"../data/us.json").await(ready);function ready(error,json,us){if(error)throw error;bins=json;x.domain(d3.extent(bins,function(d){return d.count}));mesh=topojson.mesh(us,us.objects.us);usa=topojson.merge(us,us.objects.us.geometries);console.log("before",bins.length);var contains=bins.map(function(d){return false});usa.coordinates.forEach(function(d,i){polygon=d[0].map(function(d){return projection(d)});if(!polygon[0])return;bins.forEach(function(bin,i){contains[i]=contains[i]||d3.polygonContains(polygon,[bin.x,bin.y])})});bins=bins.filter(function(bin,i){return contains[i]});console.log("after",bins.length);console.log("bins[0]",bins[0]);nodes=bins.map(function(d){d.x0=d.x;d.y0=d.y});svg.append("g").selectAll("path.state").data([usa]).enter().append("path").attr("class","state").style("fill","none").attr("d",path);svg.append("g").selectAll("path.mesh").data([mesh]).enter().append("path").attr("class","mesh").style("fill","none").attr("d",path);hexagons=svg.append("g").attr("class","hexagons").selectAll("path").data(bins).enter().append("circle").style("fill","none").attr("r",3).attr("cx",function(d){return d.x=width/2}).attr("cy",function(d){return d.y=height/2}).on("mouseover",function(d){console.log(d3.format(",d")(d.count))});d3.selectAll("form.color input").on("change",recolor).call(recolor);simulation=d3.forceSimulation(bins).velocityDecay(.4).force("x",d3.forceX(function(d){return d.x0}).strength(.1)).force("y",d3.forceY(function(d){return d.y0}).strength(.1)).on("tick",ticked);d3.select("body").on("mousedown",mousedown);d3.selectAll("form.force input").on("click",restart);d3.selectAll("form.initial-condition input").on("click",restart);restart()}function restart(){d3.event?d3.event.stopPropagation():null;simulation.stop().alpha(1).velocityDecay(+d3.selectAll("form.force input:checked").node().value);var random=d3.select("form.initial-condition #random").node().checked;bins.forEach(function(d,i){d.x=width/2+(random?(Math.random()-.5)*width/4:0);d.y=height/2+(random?(Math.random()-.5)*height/4:0)});simulation.restart()}function mousedown(){simulation.stop().alpha(1);bins.forEach(function(d,i){d.x+=(Math.random()-.5)*40;d.y+=(Math.random()-.5)*40});simulation.restart()}function ticked(){var alpha=simulation.alpha();hexagons.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y})}function recolor(){var strokeShade=+d3.selectAll("form#strokeshade input:checked").node().value;var strokeWidth=d3.selectAll("form#strokewidth input:checked").node().value;var flat=d3.select("input#flat").node().checked;var land=d3.select("input#land").node().checked;var background=d3.select("input#background").node().checked;var color=null;d3.selectAll("form input").each(function(){if(this.checked)color=d3[this.value]});d3.selectAll(".hexagons circle").style("fill",function(d){return flat?color(.7):color(x(d.count))});d3.selectAll(".hexagons path").style("fill",function(d){return flat?color(.7):color(x(d.count))});d3.selectAll("path.state").style("fill",function(d){return land?color(.1):"#ffffff"});d3.selectAll("path.mesh").style("stroke-width",strokeWidth).style("stroke",color(strokeShade));svg.select("rect").style("fill",function(){return background?"#aaa":"#fff"});if(typeof svg2png==="function")svg2png()}