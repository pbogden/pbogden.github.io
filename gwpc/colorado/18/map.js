function matrix3d(e,t){var n=e/256,r=e%1?Number:Math.round;return"matrix3d("+[n,0,0,0,0,n,0,0,0,0,n,0,r(t[0]*e),r(t[1]*e),0,1]+")"}function prefixMatch(e){var t=-1,n=e.length,r=document.body.style;while(++t<n)if(e[t]+"Transform"in r)return"-"+e[t].toLowerCase()+"-";return""}function formatLocation(e,t){var n=d3.format("."+Math.floor(Math.log(t)/2)+"f");return(e[1]<0?n(-e[1])+"째S":n(e[1])+"째N")+" "+(e[0]<0?n(-e[0])+"째W":n(e[0])+"째E")}var width=960,height=500;prefix=prefixMatch(["webkit","ms","Moz","O"]),urls=[".tiles.mapbox.com/v3/examples.map-i86nkdio/",".tile.stamen.com/watercolor/"];var tiler=d3.geo.tile().size([width,height]),projection=d3.geo.mercator(),path=d3.geo.path().projection(projection),myMap=d3.select("#myMap").style("width",width+"px").style("height",height+"px"),svg=d3.select("#myVectors").style("width",width+"px").style("height",height+"px").append("svg").attr("width",width).attr("height",height);d3.json("https://gist.githubusercontent.com/pbogden/76beef9d73df89af1078/raw/us.json",function(e,t){function l(){var e=d3.select(this).attr("value");if(e>0){f.attr("src","");return}f.attr("src",function(t){return"http://"+["a","b","c","d"][Math.random()*4|0]+urls[e]+t[2]+"/"+t[0]+"/"+t[1]+".png"})}function c(){a.text(formatLocation(projection.invert(d3.mouse(this)),o.scale))}var n=topojson.feature(t,t.objects.us).features.filter(function(e){return e.properties.name==="Colorado"})[0];projection.scale(1).translate([0,0]);var r=path.bounds(n),i=.95/Math.max((r[1][0]-r[0][0])/width,(r[1][1]-r[0][1])/height),s=[(width-i*(r[1][0]+r[0][0]))/2,(height-i*(r[1][1]+r[0][1]))/2];i=43939,s=[80901.2173478916,32668.438478050557],projection.scale(i).translate(s),svg.append("path").datum(n).attr("class","state").attr("d",path),svg.selectAll("g").data(tiler.scale(projection.scale()*2*Math.PI).translate(projection([0,0]))).enter().append("g").each(function(e){var t=d3.select(this);d3.json("http://"+["a","b","c"][(e[0]*31+e[1])%3]+".tile.openstreetmap.us/vectiles-highroad/"+e[2]+"/"+e[0]+"/"+e[1]+".json",function(e,n){t.selectAll("path").data(n.features.sort(function(e,t){return e.properties.sort_key-t.properties.sort_key})).enter().append("path").attr("class",function(e){return e.properties.kind}).attr("d",path)})}),svg.on("mousemove",c);var o=d3.geo.tile().size([width,height]).scale(i*2*Math.PI).translate(s)(),u=myMap.append("div").attr("class","layer"),a=myMap.append("div").attr("class","info"),f=u.style(prefix+"transform",matrix3d(o.scale,o.translate)).selectAll(".tile").data(o,function(e){return e});f.enter().append("img").attr("class","tile").style("left",function(e){return(e[0]<<8)+"px"}).style("top",function(e){return(e[1]<<8)+"px"}),d3.selectAll("#myForm input").on("change",l),setTimeout(function(){var e=d3.select("input").property("checked",!0);setTimeout(function(){e.each(l)},1e3)},2e3)})