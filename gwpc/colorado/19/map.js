function mousemoved(){info.text(formatLocation(projection.invert(d3.mouse(this)),tiler().scale*2*Math.PI))}function matrix3d(e,t){var n=e/256,r=e%1?Number:Math.round;return"matrix3d("+[n,0,0,0,0,n,0,0,0,0,n,0,r(t[0]*e),r(t[1]*e),0,1]+")"}function prefixMatch(e){var t=-1,n=e.length,r=document.body.style;while(++t<n)if(e[t]+"Transform"in r)return"-"+e[t].toLowerCase()+"-";return""}function formatLocation(e,t){var n=d3.format("."+Math.floor(Math.log(t)/2)+"f");return(e[1]<0?n(-e[1])+"째S":n(e[1])+"째N")+" "+(e[0]<0?n(-e[0])+"째W":n(e[0])+"째E")}function zoomed(){console.log("zoom has been called",zoom.scale(),zoom.translate()),projection.scale(zoom.scale()).translate(zoom.translate()),addRasterTiles(),addVectorTiles(),svg.select(".state").attr("d",path),svg.selectAll(".county").attr("d",path)}function addVectorTiles(){if(!myCheckbox.node().checked){vectorTiles.selectAll("g.vectors").remove();return}var e=vectorTiles.selectAll("g.vectors").data(tiler.scale(projection.scale()*2*Math.PI).translate(projection([0,0])));e.enter().append("g").attr("class","vectors").each(function(e){var t=d3.select(this);d3.json("http://"+["a","b","c"][(e[0]*31+e[1])%3]+osm+e[2]+"/"+e[0]+"/"+e[1]+".json",function(e,n){var r=t.selectAll("path").data(n.features.sort(function(e,t){return e.properties.sort_key-t.properties.sort_key}));r.enter().append("path").attr("class",function(e){return e.properties.kind}).attr("d",path),r.attr("class",function(e){return e.properties.kind}).attr("d",path),r.exit().remove()})}),e.each(function(e){var t=d3.select(this);d3.json("http://"+["a","b","c"][(e[0]*31+e[1])%3]+osm+e[2]+"/"+e[0]+"/"+e[1]+".json",function(e,n){var r=t.selectAll("path").data(n.features.sort(function(e,t){return e.properties.sort_key-t.properties.sort_key}));r.enter().append("path").attr("class",function(e){return e.properties.kind}).attr("d",path),r.attr("class",function(e){return e.properties.kind}).attr("d",path),r.exit().remove()})}),e.exit().remove()}function addRasterTiles(){var e,t=tiler.scale(projection.scale()*2*Math.PI).translate(projection.translate())();myRadios.each(function(t,n){this.checked&&(e=urls[n])});var n=myMap.style(prefix+"transform",matrix3d(t.scale,t.translate)).selectAll(".tile").data(t,function(e){return e});if(e===""){n.remove();return}n.enter().append("img").attr("class","tile").attr("src",function(t){return"http://"+["a","b","c"][Math.random()*3|0]+e+t[2]+"/"+t[0]+"/"+t[1]+".png"}).style("left",function(e){return(e[0]<<8)+"px"}).style("top",function(e){return(e[1]<<8)+"px"}),n.attr("src",function(t){return"http://"+["a","b","c"][Math.random()*3|0]+e+t[2]+"/"+t[0]+"/"+t[1]+".png"}),n.exit().remove()}function clicked(e){console.log("Clicked"),d3.select("#myCheckbox").style("visibility","visible"),projection.scale(1).translate([0,0]);var t=path.bounds(e),n=Math.max(.95/Math.max((t[1][0]-t[0][0])/width,(t[1][1]-t[0][1])/height),4e4),r=[(width-n*(t[1][0]+t[0][0]))/2,(height-n*(t[1][1]+t[0][1]))/2];projection.scale(n).translate(r),zoom.scale(n).translate(r),addRasterTiles(),svg.select(".state").attr("d",path),svg.selectAll(".county").attr("d",path)}var width=700,height=500,prefix=prefixMatch(["webkit","ms","Moz","O"]),urls=[".tiles.mapbox.com/v3/examples.map-i86nkdio/",".tiles.mapbox.com/v3/brunosan.map-cyglrrfu/",".tile.thunderforest.com/cycle/",".tile.stamen.com/terrain-background/",".tile.stamen.com/watercolor/",""],osm=".tile.openstreetmap.us/vectiles-highroad/",tiler=d3.geo.tile().size([width,height]),projection=d3.geo.mercator(),path=d3.geo.path().projection(projection),zoom=d3.behavior.zoom().on("zoomend",zoomed),myMap=d3.select("#myMap").style("width",width+"px").style("height",height+"px").append("div").attr("class","layer").call(zoom).on("mousemove",mousemoved),svg=d3.select("#myVectors").style("width",width+"px").style("height",height+"px").append("svg").attr("width",width).attr("height",height),vectorTiles=svg.append("g").attr("class","vector-tiles"),vectors=svg.append("g").attr("class","vectors"),info=d3.select("#myVectors").append("div").attr("class","info"),myRadios=d3.selectAll("#myRadios input").on("change",addRasterTiles),myCheckbox=d3.selectAll("#myCheckbox input").on("change",addVectorTiles);d3.json("https://gist.githubusercontent.com/pbogden/48418ad20456b251e5a8/raw/co.json",function(e,t){e&&console.log(e);var n=topojson.feature(t,t.objects.co).features,r=topojson.merge(t,t.objects.co.geometries);projection.scale(1).translate([0,0]);var i=path.bounds(r),s=.95/Math.max((i[1][0]-i[0][0])/width,(i[1][1]-i[0][1])/height),o=[(width-s*(i[1][0]+i[0][0]))/2,(height-s*(i[1][1]+i[0][1]))/2];projection.scale(s).translate(o),zoom.scale(s).translate(o),vectors.append("path").datum(r).attr("class","state").attr("d",path),vectors.selectAll(".county").data(n).enter().append("path").attr("class","county").attr("d",path).call(zoom).on("mousemove",mousemoved).on("click",clicked),addRasterTiles(),addVectorTiles()})