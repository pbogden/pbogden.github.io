<!DOCTYPE html>
<meta charset="utf-8">
<title>colorado8</title>

<style>

div, svg {
  font: 16px sans-serif;
  display: inline-block;
}

path.counties, path.county-border {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

path.state {
  fill: none;
  stroke: #000;
}

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="colorado.js"></script>
<body>
<script>

var width = 200, height = 500;

var formations = ["Dawson", "Upper Dawson", "Lower Dawson", "Denver",
    "Arapahoe", "Upper Arapahoe", "Lower Arapahoe", "Laramie Fox Hills"];

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var labels = d3.select("svg").selectAll(".formation")
    .data(formations)
  .enter().append("g")
    .attr("class", "formation")
    .attr("transform", function(d, i) { return "translate( 10," + i*10 + ")"; });

var colorado = d3.colorado()
    .size([960 - width, height])
    ();

labels.append("rect")
    .attr("width", "150px")
    .attr("height", "1.5em")
    .attr("y", function(d, i) { return i * 1.1 + "em" })
    .style("fill-opacity", 0.1);

labels.append("text")
    .attr("x", "1em")
    .attr("y", function(d, i) { return (i + 1) * 1.1 + "em" })
    .text(function(d) { return d; });

queue()
    .defer(d3.json, "file.json")
    .await(ready);

function ready(error, data) {

  labels.on("mouseover", plotFormation);

  function plotFormation(d) {

    // Filter by formation
    var formation = d.replace(/\s/g,"_").toLowerCase();
    var values = data.filter(function(d) { return d.hasOwnProperty(formation + "_base"); });

//values.forEach( function(d, i) { console.log(i, "coordinates:", d.location.coordinates) })

    // Filter by existance of "location" property
    var n = values.length;
    var values = values.filter(function(d) { return (typeof d.location !== "undefined"); });
    if (n != values.length) console.log('WARNING...location missing for:', n - values.length);

    // Add "value" property that will be plotted
    values = values.map(function(d) { 
        d.value = d[formation + "_base"]; 
        return d; 
    });
    console.log(formation + " values.length:", values.length, ', values[0]', values[0]);

    // check for duplicate locations
    chk = d3.merge([ values, values]);
    nest = d3.nest()
        .key(function(d) { return d.location.coordinates[0] })
        .key(function(d) { return d.location.coordinates[1] })
        .map(chk, d3.map)

    nest.values().forEach(function(d, i) { 
      if (i < 3) console.log('d.length > 1, d:', d.keys().length, d ); 
      if (d.keys().length > 1) console.log('WARNING...d.length > 1, d:', d.keys().length, d ); 
    });
  
    d3.selectAll(".formation rect").style("fill-opacity", 0.1);
    d3.select(this).select("rect").style("fill-opacity", 0.3);

    svg.selectAll(".circle").remove();

    svg.append("text")
        .attr("class", "circle")
        .attr("x", "1em")
        .attr("y", height / 2)
        .style("font-size", "20px")
        .text(d3.format(',.0f')(values.length) + " wells");

    colorado
        .data(values)
//        .plotem();
        .voronoi();
  }
}

</script>
