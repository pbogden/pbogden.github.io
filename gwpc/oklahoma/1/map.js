function mousemoved(){info.text(formatLocation(projection.invert(d3.mouse(this)),2*tiler().scale*Math.PI))}function matrix3d(t,e){var o=t/256,a=t%1?Number:Math.round;return"matrix3d("+[o,0,0,0,0,o,0,0,0,0,o,0,a(e[0]*t),a(e[1]*t),0,1]+")"}function prefixMatch(t){for(var e=-1,o=t.length,a=document.body.style;++e<o;)if(t[e]+"Transform"in a)return"-"+t[e].toLowerCase()+"-";return""}function formatLocation(t,e){var o=d3.format("."+Math.floor(Math.log(e)/2)+"f");return(t[1]<0?o(-t[1])+"\xb0S":o(t[1])+"\xb0N")+" "+(t[0]<0?o(-t[0])+"\xb0W":o(t[0])+"\xb0E")}function changed(){layer.selectAll(".tile").remove(),zoomed()}function checked(){vectors.style("visibility",this.checked?"visible":"hidden")}function zoomed(){function t(t){var e=urls[n];return e.indexOf("mqcdn")>-1?"http://otile"+["1","2","3","4"][0|4*Math.random()]+e+t[2]+"/"+t[0]+"/"+t[1]+".png":"http://"+["a","b","c"][0|3*Math.random()]+e+t[2]+"/"+t[0]+"/"+t[1]+".png"}var e=tiler.scale(zoom.scale()).translate(zoom.translate())(),o=layer.style(prefix+"transform",matrix3d(e.scale,e.translate)).selectAll(".tile").data(e,function(t){return t});projection.scale(zoom.scale()/2/Math.PI).translate(zoom.translate()),d3.select("#myCheckbox").style("visibility",function(){return e[0][2]>=10?"visible":"hidden"});var a=vectors.style(prefix+"transform",matrix3d(e.scale,e.translate)).selectAll(".tile").data(e,function(t){return t});a.exit().each(function(){this._xhr.abort()}).remove(),a.enter().append("svg").attr("class","tile").style("left",function(t){return 256*t[0]+"px"}).style("top",function(t){return 256*t[1]+"px"}).each(function(t){var e=d3.select(this);this._xhr=d3.json("http://"+["a","b","c"][(31*t[0]+t[1])%3]+".tile.openstreetmap.us/vectiles-highroad/"+t[2]+"/"+t[0]+"/"+t[1]+".json",function(o,a){o&&console.log("can't get vector tile for",t[2]);var n=256*Math.pow(2,t[2]);tilePath.projection().translate([n/2-256*t[0],n/2-256*t[1]]).scale(n/2/Math.PI),e.selectAll("path").data(a.features.sort(function(t,e){return t.properties.sort_key-e.properties.sort_key})).enter().append("path").attr("class",function(t){return t.properties.kind}).attr("d",tilePath),e.append("path").datum(state).attr("class","state").attr("d",tilePath),e.append("path").datum(counties).attr("class","county").attr("d",tilePath)})});var n;myRadios.each(function(t,e){this.checked&&(n=e)}),url=urls[n],url&&(o.enter().append("img").attr("class","tile").style("left",function(t){return(t[0]<<8)+"px"}).style("top",function(t){return(t[1]<<8)+"px"}).attr("src",t),o.exit().remove())}function clicked(t){if(console.log("Clicked"),d3.select("#myCheckbox").style("visibility","visible"),projection.scale()>=4e4)return console.log("Clicked returning early"),void 0;projection.scale(1).translate([0,0]);var e=path.bounds(t),o=Math.max(.95/Math.max((e[1][0]-e[0][0])/width,(e[1][1]-e[0][1])/height),4e4),a=[(width-o*(e[1][0]+e[0][0]))/2,(height-o*(e[1][1]+e[0][1]))/2];projection.scale(o).translate(a),zoom.scale(o).translate(a)}d3.geo.tile=function(){function t(){var t=Math.max(Math.log(o)/Math.LN2-8,0),r=Math.round(t+n),i=Math.pow(2,t-r+8),s=[(a[0]-o/2)/i,(a[1]-o/2)/i],c=[],l=d3.range(Math.max(0,Math.floor(-s[0])),Math.max(0,Math.ceil(e[0]/i-s[0]))),h=d3.range(Math.max(0,Math.floor(-s[1])),Math.max(0,Math.ceil(e[1]/i-s[1])));return h.forEach(function(t){l.forEach(function(e){c.push([e,t,r])})}),c.translate=s,c.scale=i,c}var e=[960,500],o=256,a=[e[0]/2,e[1]/2],n=0;return t.size=function(o){return arguments.length?(e=o,t):e},t.scale=function(e){return arguments.length?(o=e,t):o},t.translate=function(e){return arguments.length?(a=e,t):a},t.zoomDelta=function(e){return arguments.length?(n=+e,t):n},t};var width=700,height=500,prefix=prefixMatch(["webkit","ms","Moz","O"]),urls=[".tiles.mapbox.com/v3/examples.map-i86nkdio/",".tiles.mapbox.com/v3/brunosan.map-cyglrrfu/",".mqcdn.com/tiles/1.0.0/map/",".mqcdn.com/tiles/1.0.0/sat/",".tile.thunderforest.com/landscape/",".tile.thunderforest.com/cycle/",".tile.stamen.com/terrain-background/",".tile.stamen.com/toner/",".tile.stamen.com/watercolor/",""],osm=".tile.openstreetmap.us/vectiles-highroad/",state,counties,tiler=d3.geo.tile().size([width,height]),z0=6.75,k0=Math.pow(2,8+z0),projection=d3.geo.mercator().scale(k0/2/Math.PI).translate([-width/2,-height/2]),tileProjection=d3.geo.mercator(),tilePath=d3.geo.path().projection(tileProjection),path=d3.geo.path().projection(projection),center=projection([-98.75,35.5]),zoom=d3.behavior.zoom().scale(2*projection.scale()*Math.PI).scaleExtent([32768,1<<20]).translate(center.map(function(t){return-t})).on("zoom",zoomed),map=d3.select("body").append("div").attr("class","map").style("width",width+"px").style("height",height+"px").call(zoom).on("mousemove",mousemoved),layer=map.append("div").attr("class","layer"),vectors=map.append("div").attr("class","layer"),info=map.append("div").attr("class","info"),myRadios=d3.selectAll("#myRadios input").on("change",changed),myCheckbox=d3.selectAll("#myCheckbox input").on("change",checked);d3.json("ok.json",function(t,e){t&&console.log(t),state=topojson.merge(e,e.objects.ok.geometries),counties=topojson.mesh(e,e.objects.ok,function(t,e){return t!==e}),zoomed()});